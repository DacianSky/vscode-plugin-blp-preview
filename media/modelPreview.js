(()=>{"use strict";var t={};(t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})})(t);var e="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function a(t){var e=t[0],n=t[1],a=t[2];return Math.hypot(e,n,a)}function i(t,n,a){var i=new e(3);return i[0]=t,i[1]=n,i[2]=a,i}function o(t,e,n,a){return t[0]=e,t[1]=n,t[2]=a,t}function s(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function r(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function h(t,e){var n=e[0],a=e[1],i=e[2],o=n*n+a*a+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function l(t,e,n){var a=e[0],i=e[1],o=e[2],s=n[3]*a+n[7]*i+n[11]*o+n[15];return s=s||1,t[0]=(n[0]*a+n[4]*i+n[8]*o+n[12])/s,t[1]=(n[1]*a+n[5]*i+n[9]*o+n[13])/s,t[2]=(n[2]*a+n[6]*i+n[10]*o+n[14])/s,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function c(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}n(),function(){var t;t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();var u;n(),i(1,0,0),i(0,1,0),c(),c(),u=new e(9),e!=Float32Array&&(u[1]=0,u[2]=0,u[3]=0,u[5]=0,u[6]=0,u[7]=0),u[0]=1,u[4]=1,u[8]=1;const d=n(),m=n(),v=c(),p=new Float32Array(1);function g(t,e){let n=e.clientX-t.clientX,a=e.clientY-t.clientY;return Math.sqrt(n*n+a*a)}class f{constructor(t,e={}){this.scene=t,this.canvas=t.viewer.canvas,this.camera=t.camera,this.moveSpeed=e.moveSpeed||2,this.rotationSpeed=e.rotationSpeed||Math.PI/180,this.zoomFactor=e.zoomFactor||.1,this.horizontalAngle=e.horizontalAngle||Math.PI/2,this.verticalAngle=e.verticalAngle||Math.PI/4,this.distance=e.distance||500,this.position=e.position||n(),this.target=e.target||n(),this.twist=e.twist||0,this.mouse={buttons:[!1,!1,!1],x:0,y:0,x2:0,y2:0},this.touchMode=-1,this.touches=[],this.instance=null,this.onManualChange=e.onManualChange||null,this.fov=e.fov||Math.PI/4,this.nearClipPlane=e.nearClipPlane||1,this.farClipPlane=e.farClipPlane||2e5,this.update(),window.addEventListener("resize",(t=>this.onResize())),setTimeout((()=>this.onResize()),0),this.canvas.addEventListener("contextmenu",(t=>t.preventDefault())),this.canvas.addEventListener("selectstart",(t=>t.preventDefault())),this.canvas.addEventListener("mousedown",(t=>{t.preventDefault(),this.mouse.buttons[t.button]=!0})),document.addEventListener("mouseup",(t=>{t.preventDefault(),this.mouse.buttons[t.button]=!1})),window.addEventListener("mousemove",(t=>{this.mouse.x2=this.mouse.x,this.mouse.y2=this.mouse.y,this.mouse.x=t.clientX,this.mouse.y=t.clientY;let e=this.mouse.x-this.mouse.x2,n=this.mouse.y-this.mouse.y2;this.mouse.buttons[0]&&this.rotate(e,n),this.mouse.buttons[2]&&this.move(-e,n)})),this.canvas.addEventListener("wheel",(t=>{t.preventDefault();let e=t.deltaY;1===t.deltaMode&&(e=e/3*100),this.zoom(e/100)})),this.canvas.addEventListener("touchstart",(t=>{t.preventDefault();let e=t.targetTouches;1===e.length?this.touchMode=0:2==e.length?this.touchMode=1:this.touchMode=-1,this.touches.length=0,this.touches.push(...e)})),this.canvas.addEventListener("touchend",(t=>{t.preventDefault(),this.touchMode=-1})),this.canvas.addEventListener("touchcancel",(t=>{t.preventDefault(),this.touchMode=-1})),this.canvas.addEventListener("touchmove",(t=>{t.preventDefault();let e=t.targetTouches;if(0===this.touchMode){let t=this.touches[0],n=e[0],a=n.clientX-t.clientX,i=n.clientY-t.clientY;this.rotate(a,i)}else if(1===this.touchMode){let t=g(this.touches[0],this.touches[1]),n=g(e[0],e[1]);this.zoom((t-n)/50)}this.touches.length=0,this.touches.push(...e)}))}update(){if(this.instance){let t=this.instance,e=t.model.cameras[0];e.getTranslation(d,t.sequence,t.frame,t.counter),s(d,d,e.position),e.getTargetTranslation(m,t.sequence,t.frame,t.counter),s(m,m,e.targetPosition),e.getRotation(p,t.sequence,t.frame,t.counter),this.twist=p[0],l(d,d,t.worldMatrix),l(m,m,t.worldMatrix),this.moveToAndFace(d,m)}else this.updateInternalCamera()}move(t,e){let n=this.camera.directionX,a=this.camera.directionY,i=this.canvas.width,l=this.canvas.height,c=i/l,u=t/i*this.distance*c,m=e/l*this.distance;s(this.target,this.target,r(d,h(d,o(d,n[0],n[1],0)),u)),s(this.target,this.target,r(d,h(d,o(d,a[0],a[1],0)),m)),this.manualChange()}rotate(t,e){this.horizontalAngle-=t*this.rotationSpeed,this.verticalAngle-=e*this.rotationSpeed,this.manualChange()}zoom(t){this.distance=Math.max(1,this.distance*(1+t*this.zoomFactor)),this.manualChange()}manualChange(){this.updateInternalCamera(),this.instance&&(this.instance=null,this.onManualChange&&this.onManualChange())}onResize(){let t=Math.max(this.canvas.clientWidth,1),e=Math.max(this.canvas.clientHeight,1);this.canvas.width=t,this.canvas.height=e,this.scene.viewport[2]=t,this.scene.viewport[3]=e,this.camera.perspective(this.fov,t/e,this.nearClipPlane,this.farClipPlane)}moveToAndFace(t,e){!function(t,e,n){t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2]}(d,t,e);let n=a(d),i=Math.atan2(d[1],d[0]),o=Math.acos(d[2]/n);!function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2]}(this.target,e),this.verticalAngle=o,this.horizontalAngle=i+Math.PI/2,this.distance=n,this.updateInternalCamera()}updateInternalCamera(){this.verticalAngle=Math.min(Math.max(.01,this.verticalAngle),Math.PI-.01),function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1}(v),function(t,e,n){n*=.5;var a=e[0],i=e[1],o=e[2],s=e[3],r=Math.sin(n),h=Math.cos(n);t[0]=a*h+i*r,t[1]=i*h-a*r,t[2]=o*h+s*r,t[3]=s*h-o*r}(v,v,this.horizontalAngle),function(t,e,n){n*=.5;var a=e[0],i=e[1],o=e[2],s=e[3],r=Math.sin(n),h=Math.cos(n);t[0]=a*h+s*r,t[1]=i*h+o*r,t[2]=o*h-i*r,t[3]=s*h-a*r}(v,v,this.verticalAngle),o(this.position,0,0,1),function(t,e,n){var a=n[0],i=n[1],o=n[2],s=n[3],r=e[0],h=e[1],l=e[2],c=i*l-o*h,u=o*r-a*l,d=a*h-i*r,m=i*d-o*u,v=o*c-a*d,p=a*u-i*c,g=2*s;c*=g,u*=g,d*=g,m*=2,v*=2,p*=2,t[0]=r+c+m,t[1]=h+u+v,t[2]=l+d+p}(this.position,this.position,v),r(this.position,this.position,this.distance),s(this.position,this.position,this.target);let t=this.twist-Math.PI/2;o(d,0,-Math.cos(t),-Math.sin(t)),this.camera.moveToAndFace(this.position,this.target,d)}applyInstanceCamera(t){this.instance=t,this.fov=t.model.cameras[0].fieldOfView,this.onResize(),this.update()}}const M=ModelViewer.viewer.handlers,w=ModelViewer.common.glMatrix,y=w.vec3;w.quat;let A=document.getElementById("canvas");A.width=800,A.height=600;let C=new ModelViewer.viewer.ModelViewer(A);C.debugRenderMode=ModelViewer.viewer.DebugRenderMode.None,console.info("model",C,ModelViewer);let I,L=C.addScene();function E(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}!function(t,e={}){new f(t,e)}(L),C.on("loadstart",(t=>console.log(t))),C.on("load",(t=>console.log("load",t))),C.on("loadend",(t=>console.log("loadend",t))),C.on("error",(t=>console.log("error",t))),C.addHandler(M.mdx),C.addHandler(M.blp),C.addHandler(M.dds),C.addHandler(M.tga),requestAnimationFrame((function t(e){requestAnimationFrame(t),I?(C.updateAndRender(e-I),I=e):I=e})),window.fetch=async function(t){if(console.info("fetch",t),t.toLowerCase().endsWith("mdx")){const{buf:t}=await message.load();return{ok:!0,arrayBuffer:()=>t}}if(t.toLowerCase().endsWith(".blp")||t.toLowerCase().endsWith(".tga")||t.toLowerCase().endsWith(".dds")){const e=await message.loadBlp(t);return{ok:!0,arrayBuffer:()=>e}}return new Promise((()=>{}))};let x=null;C.load("test.mdx").then((t=>{console.info("model",t,L),L.lightPosition=y.fromValues(200,0,0),function(t){let e=t.sequences.map((t=>t.name));0===e.length&&(e=["None"]),document.getElementById("select").innerHTML=e.map(((t,e)=>`<option value="${e}">${E(t)}</option>`)).join("")}(t),document.getElementById("teamcolor").innerHTML=["红色","蓝色","青色","紫色","黄色","橙色","绿色","粉色","灰色"].map(((t,e)=>`<option value="${e}">${E(t)}</option>`)).join(""),function(){let t=document.getElementById("select");t.addEventListener("input",(()=>{x.setSequence(parseInt(t.value,10))}));let e=document.getElementById("teamcolor");e.addEventListener("input",(()=>{x.setTeamColor(parseInt(e.value,10)),x.forced=!0}));let n=document.getElementById("volume");n.addEventListener("input",(()=>{x&&(x.timeScale=parseInt(n.value,10)/10)}))}();let e=t.addInstance();x=e,e.setScene(L),e.setSequence(0),e.setSequenceLoopMode(2),e.move([0,0,0])})),module.exports=t})();